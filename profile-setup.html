<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>프로필 설정 - 인연 매칭 서비스</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide 아이콘 -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- 기본 스타일시트 -->
    <link rel="stylesheet" href="css/main.css">
</head>
<body class="bg-gray-50">
    <!-- 헤더 -->
    <header class="bg-white shadow-sm fixed w-full top-0 z-10">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <a href="index.html" class="text-2xl font-bold text-pink-600">인연</a>
                </div>
                
                <!-- 프로필 드롭다운 (로그인 상태일 때) -->
                <div id="userProfileDropdown" class="relative hidden">
                    <button id="userProfileBtn" class="flex items-center space-x-2 focus:outline-none">
                        <img id="userAvatarImg" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Ccircle cx='12' cy='12' r='12' fill='%23EC4899'/%3E%3Ctext x='12' y='16' text-anchor='middle' font-size='12' fill='white'%3EA%3C/text%3E%3C/svg%3E" class="h-8 w-8 rounded-full object-cover">
                        <span id="userDisplayName" class="text-gray-700">사용자</span>
                        <i data-lucide="chevron-down" class="h-4 w-4 text-gray-500"></i>
                    </button>
                    
                    <div id="profileDropdownMenu" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-10 hidden">
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                            <i data-lucide="user" class="h-4 w-4 inline mr-2"></i>마이페이지
                        </a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                            <i data-lucide="settings" class="h-4 w-4 inline mr-2"></i>설정
                        </a>
                        <hr class="my-1">
                        <a href="#" id="logoutBtn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                            <i data-lucide="log-out" class="h-4 w-4 inline mr-2"></i>로그아웃
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- 메인 컨텐츠 -->
    <main class="container mx-auto mt-24 px-4 py-8">
        <div class="max-w-xl mx-auto bg-white rounded-lg shadow p-6">
            <h1 class="text-2xl font-bold text-center mb-6">프로필 설정</h1>
            <p class="text-gray-600 text-center mb-8">매칭 서비스를 이용하기 위해 프로필 정보를 입력해주세요.</p>
            
            <form id="profileForm" class="space-y-6">
                <!-- 기본 정보 -->
                <div>
                    <h2 class="text-lg font-semibold mb-4">기본 정보</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="displayName" class="block text-sm font-medium text-gray-700">이름/닉네임</label>
                            <input type="text" id="displayName" name="displayName" class="mt-1 block w-full rounded-md border border-gray-300 shadow-sm py-2 px-3 focus:outline-none focus:ring-pink-500 focus:border-pink-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">성별</label>
                            <div class="mt-1 flex space-x-4">
                                <div class="flex items-center">
                                    <input type="radio" id="gender-male" name="gender" value="male" class="h-4 w-4 text-pink-600 focus:ring-pink-500 border-gray-300">
                                    <label for="gender-male" class="ml-2 block text-sm text-gray-700">남성</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" id="gender-female" name="gender" value="female" class="h-4 w-4 text-pink-600 focus:ring-pink-500 border-gray-300">
                                    <label for="gender-female" class="ml-2 block text-sm text-gray-700">여성</label>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label for="birthYear" class="block text-sm font-medium text-gray-700">출생 연도</label>
                            <select id="birthYear" name="birthYear" class="mt-1 block w-full rounded-md border border-gray-300 shadow-sm py-2 px-3 focus:outline-none focus:ring-pink-500 focus:border-pink-500">
                                <option value="">선택해주세요</option>
                                <!-- 1970부터 현재까지 -->
                            </select>
                        </div>
                        
                        <div>
                            <label for="birthday" class="block text-sm font-medium text-gray-700">생일</label>
                            <div class="grid grid-cols-2 gap-4">
                                <select id="birthMonth" name="birthMonth" class="rounded-md border border-gray-300 shadow-sm py-2 px-3 focus:outline-none focus:ring-pink-500 focus:border-pink-500">
                                    <option value="">월</option>
                                    <option value="1">1월</option>
                                    <option value="2">2월</option>
                                    <option value="3">3월</option>
                                    <option value="4">4월</option>
                                    <option value="5">5월</option>
                                    <option value="6">6월</option>
                                    <option value="7">7월</option>
                                    <option value="8">8월</option>
                                    <option value="9">9월</option>
                                    <option value="10">10월</option>
                                    <option value="11">11월</option>
                                    <option value="12">12월</option>
                                </select>
                                <select id="birthDay" name="birthDay" class="rounded-md border border-gray-300 shadow-sm py-2 px-3 focus:outline-none focus:ring-pink-500 focus:border-pink-500">
                                    <option value="">일</option>
                                    <!-- 일은 자바스크립트로 동적 생성 -->
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 추가 정보 -->
                <div>
                    <h2 class="text-lg font-semibold mb-4">추가 정보</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="location" class="block text-sm font-medium text-gray-700">지역</label>
                            <select id="location" name="location" class="mt-1 block w-full rounded-md border border-gray-300 shadow-sm py-2 px-3 focus:outline-none focus:ring-pink-500 focus:border-pink-500">
                                <option value="">지역을 선택하세요</option>
                                <option value="서울">서울</option>
                                <option value="경기">경기</option>
                                <option value="인천">인천</option>
                                <option value="강원">강원</option>
                                <option value="충북">충북</option>
                                <option value="충남">충남</option>
                                <option value="대전">대전</option>
                                <option value="경북">경북</option>
                                <option value="경남">경남</option>
                                <option value="대구">대구</option>
                                <option value="울산">울산</option>
                                <option value="부산">부산</option>
                                <option value="전북">전북</option>
                                <option value="전남">전남</option>
                                <option value="광주">광주</option>
                                <option value="제주">제주</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="phoneNumber" class="block text-sm font-medium text-gray-700">연락처 (선택)</label>
                            <input type="tel" id="phoneNumber" name="phoneNumber" placeholder="'-' 없이 입력하세요" class="mt-1 block w-full rounded-md border border-gray-300 shadow-sm py-2 px-3 focus:outline-none focus:ring-pink-500 focus:border-pink-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">관심사 (최대 5개)</label>
                            <div class="grid grid-cols-3 gap-2">
                                <div class="flex items-center">
                                    <input type="checkbox" id="interest-movie" name="interests" value="영화" class="h-4 w-4 text-pink-600 focus:ring-pink-500 border-gray-300 rounded">
                                    <label for="interest-movie" class="ml-2 block text-sm text-gray-700">영화</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="interest-music" name="interests" value="음악" class="h-4 w-4 text-pink-600 focus:ring-pink-500 border-gray-300 rounded">
                                    <label for="interest-music" class="ml-2 block text-sm text-gray-700">음악</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="interest-travel" name="interests" value="여행" class="h-4 w-4 text-pink-600 focus:ring-pink-500 border-gray-300 rounded">
                                    <label for="interest-travel" class="ml-2 block text-sm text-gray-700">여행</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="interest-food" name="interests" value="맛집" class="h-4 w-4 text-pink-600 focus:ring-pink-500 border-gray-300 rounded">
                                    <label for="interest-food" class="ml-2 block text-sm text-gray-700">맛집</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="interest-exercise" name="interests" value="운동" class="h-4 w-4 text-pink-600 focus:ring-pink-500 border-gray-300 rounded">
                                    <label for="interest-exercise" class="ml-2 block text-sm text-gray-700">운동</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="interest-reading" name="interests" value="독서" class="h-4 w-4 text-pink-600 focus:ring-pink-500 border-gray-300 rounded">
                                    <label for="interest-reading" class="ml-2 block text-sm text-gray-700">독서</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="interest-game" name="interests" value="게임" class="h-4 w-4 text-pink-600 focus:ring-pink-500 border-gray-300 rounded">
                                    <label for="interest-game" class="ml-2 block text-sm text-gray-700">게임</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="interest-outdoor" name="interests" value="아웃도어" class="h-4 w-4 text-pink-600 focus:ring-pink-500 border-gray-300 rounded">
                                    <label for="interest-outdoor" class="ml-2 block text-sm text-gray-700">아웃도어</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="interest-art" name="interests" value="예술" class="h-4 w-4 text-pink-600 focus:ring-pink-500 border-gray-300 rounded">
                                    <label for="interest-art" class="ml-2 block text-sm text-gray-700">예술</label>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label for="bio" class="block text-sm font-medium text-gray-700">자기소개</label>
                            <textarea id="bio" name="bio" rows="3" class="mt-1 block w-full rounded-md border border-gray-300 shadow-sm py-2 px-3 focus:outline-none focus:ring-pink-500 focus:border-pink-500"></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="pt-4">
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-pink-600 hover:bg-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-500">
                        프로필 저장하기
                    </button>
                </div>
            </form>
        </div>
    </main>

    <!-- 스크립트 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
        import { app } from './js/firebase-config.js';
        
        // Firebase 초기화
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // 날짜 옵션 초기화
        function initDateOptions() {
            // 연도 옵션 추가 (1970년부터 현재까지)
            const birthYearSelect = document.getElementById('birthYear');
            const currentYear = new Date().getFullYear();
            for (let year = currentYear; year >= 1970; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                birthYearSelect.appendChild(option);
            }
            
            // 일 옵션 업데이트 함수
            function updateDayOptions() {
                const month = parseInt(document.getElementById('birthMonth').value) || 0;
                const birthDaySelect = document.getElementById('birthDay');
                
                // 기존 옵션 제거
                while (birthDaySelect.options.length > 1) {
                    birthDaySelect.remove(1);
                }
                
                if (month === 0) return;
                
                // 월에 따른 일수 계산
                let daysInMonth = 31;
                if ([4, 6, 9, 11].includes(month)) {
                    daysInMonth = 30;
                } else if (month === 2) {
                    // 2월은 28일로 단순화 (윤년 고려 X)
                    daysInMonth = 28;
                }
                
                // 일 옵션 추가
                for (let day = 1; day <= daysInMonth; day++) {
                    const option = document.createElement('option');
                    option.value = day;
                    option.textContent = day;
                    birthDaySelect.appendChild(option);
                }
            }
            
            // 월 선택 시 일 옵션 업데이트
            document.getElementById('birthMonth').addEventListener('change', updateDayOptions);
        }
        
        // 프로필 폼 제출 처리
        function setupProfileForm() {
            const profileForm = document.getElementById('profileForm');
            
            profileForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const user = auth.currentUser;
                if (!user) {
                    alert('로그인이 필요합니다.');
                    window.location.href = 'index.html';
                    return;
                }
                
                // 필수 입력값 검증
                const displayName = document.getElementById('displayName').value.trim();
                const gender = document.querySelector('input[name="gender"]:checked')?.value;
                const birthYear = document.getElementById('birthYear').value;
                const birthMonth = document.getElementById('birthMonth').value;
                const birthDay = document.getElementById('birthDay').value;
                const location = document.getElementById('location').value;
                
                if (!displayName || !gender || !birthYear || !birthMonth || !birthDay || !location) {
                    alert('필수 항목을 모두 입력해주세요.');
                    return;
                }
                
                // 관심사 수집
                const interestCheckboxes = document.querySelectorAll('input[name="interests"]:checked');
                if (interestCheckboxes.length > 5) {
                    alert('관심사는 최대 5개까지 선택 가능합니다.');
                    return;
                }
                
                const interests = Array.from(interestCheckboxes).map(cb => cb.value);
                
                // 생년월일 포맷팅
                const birthdate = `${birthYear}-${birthMonth.padStart(2, '0')}-${birthDay.padStart(2, '0')}`;
                
                // 추가 정보
                const phoneNumber = document.getElementById('phoneNumber').value.trim();
                const bio = document.getElementById('bio').value.trim();
                
                try {
                    // Firestore에 프로필 정보 저장
                    await setDoc(doc(db, "users", user.uid), {
                        displayName,
                        gender,
                        birthYear: parseInt(birthYear),
                        birthMonth: parseInt(birthMonth),
                        birthDay: parseInt(birthDay),
                        birthdate,
                        location,
                        phoneNumber,
                        interests,
                        bio,
                        profileCompleted: true,
                        updatedAt: new Date()
                    }, { merge: true });
                    
                    alert('프로필이 저장되었습니다!');
                    window.location.href = 'index.html'; // 메인 페이지로 이동
                } catch (error) {
                    console.error('프로필 저장 오류:', error);
                    alert('프로필 저장 중 오류가 발생했습니다.');
                }
            });
        }
        
        // 기존 프로필 정보 로드
        async function loadUserProfile() {
            const user = auth.currentUser;
            if (!user) return;
            
            try {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    
                    // 기본 정보 설정
                    document.getElementById('displayName').value = userData.displayName || user.displayName || '';
                    
                    // 성별 설정
                    if (userData.gender) {
                        document.getElementById(`gender-${userData.gender}`).checked = true;
                    }
                    
                    // 생년월일 설정
                    if (userData.birthYear) {
                        document.getElementById('birthYear').value = userData.birthYear;
                    }
                    if (userData.birthMonth) {
                        document.getElementById('birthMonth').value = userData.birthMonth;
                        
                        // 일 옵션 업데이트 후 값 설정
                        const event = new Event('change');
                        document.getElementById('birthMonth').dispatchEvent(event);
                        
                        if (userData.birthDay) {
                            setTimeout(() => {
                                document.getElementById('birthDay').value = userData.birthDay;
                            }, 100);
                        }
                    }
                    
                    // 지역 설정
                    if (userData.location) {
                        document.getElementById('location').value = userData.location;
                    }
                    
                    // 연락처 설정
                    if (userData.phoneNumber) {
                        document.getElementById('phoneNumber').value = userData.phoneNumber;
                    }
                    
                    // 관심사 설정
                    if (userData.interests && Array.isArray(userData.interests)) {
                        userData.interests.forEach(interest => {
                            const checkbox = document.querySelector(`input[name="interests"][value="${interest}"]`);
                            if (checkbox) {
                                checkbox.checked = true;
                            }
                        });
                    }
                    
                    // 자기소개 설정
                    if (userData.bio) {
                        document.getElementById('bio').value = userData.bio;
                    }
                }
            } catch (error) {
                console.error('프로필 로드 오류:', error);
            }
        }
        
        // 로그아웃 처리
        function setupLogout() {
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    try {
                        await auth.signOut();
                        window.location.href = 'index.html';
                    } catch (error) {
                        console.error('로그아웃 오류:', error);
                    }
                });
            }
        }
        
        // 사용자 인증 상태 확인
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                // 로그인되지 않은 경우 메인 페이지로 리디렉션
                alert('로그인이 필요한 페이지입니다.');
                window.location.href = 'index.html';
                return;
            }
            
            // 프로필 UI 업데이트
            const userProfileDropdown = document.getElementById('userProfileDropdown');
            const userDisplayName = document.getElementById('userDisplayName');
            const userAvatarImg = document.getElementById('userAvatarImg');
            
            if (userProfileDropdown) userProfileDropdown.classList.remove('hidden');
            if (userDisplayName) userDisplayName.textContent = user.displayName || '사용자';
            if (userAvatarImg && user.photoURL) userAvatarImg.src = user.photoURL;
            
            // 프로필 정보 로드
            await loadUserProfile();
        });
        
        // 초기화 함수 실행
        document.addEventListener('DOMContentLoaded', () => {
            // 아이콘 초기화
            lucide.createIcons();
            
            // 날짜 옵션 초기화
            initDateOptions();
            
            // 프로필 폼 설정
            setupProfileForm();
            
            // 로그아웃 기능 설정
            setupLogout();
        });
    </script>
</body>
</html>
